<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <title>Inicio de sesi√≥n</title>
</head>

<body>
  <div class="container text-center my-5">
    <h1>Inicio de sesi√≥n - Agente Digital Per√∫</h1>
    <img src="/img/logo.png" alt="LOGO" class="img-fluid mb-3" style="max-width: 200px;">
    <button id="btnScan" class="btn btn-primary btn-lg px-5 py-3">
      <i class="bi bi-qr-code-scan me-2"></i>Escanear QR
    </button>
  </div>

  <!-- Modal de Contrase√±a -->
  <div class="modal fade" id="passwordModal" data-bs-backdrop="static" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">
            <i class="bi bi-key-fill me-2"></i>Ingresa tu contrase√±a
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p id="msgPassword" class="text-muted text-center mb-3"></p>
          <input type="password" id="passwordInput" class="form-control form-control-lg" 
                 placeholder="Contrase√±a" autocomplete="current-password">
          <input type="hidden" id="customerIdInput">
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="bi bi-x-circle me-2"></i>Cancelar
          </button>
          <button id="btnPassword" class="btn btn-primary">
            <i class="bi bi-arrow-right-circle me-2"></i>Continuar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de C√≥digo de Verificaci√≥n -->
  <div class="modal fade" id="codeModal" data-bs-backdrop="static" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title">
            <i class="bi bi-envelope-check me-2"></i>C√≥digo de Verificaci√≥n
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body text-center">
          <p class="text-muted mb-3">
            <i class="bi bi-info-circle me-2"></i>
            Hemos enviado un c√≥digo de 6 d√≠gitos a tu email
          </p>
          <p id="msgEmail" class="fw-bold mb-3"></p>
          <input type="text" id="codeInput" class="form-control form-control-lg text-center" 
                 placeholder="000000" maxlength="6" pattern="[0-9]{6}" 
                 style="font-size: 24px; letter-spacing: 8px;">
          <small class="text-muted d-block mt-2">El c√≥digo expira en 5 minutos</small>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="bi bi-x-circle me-2"></i>Cancelar
          </button>
          <button id="btnVerifyCode" class="btn btn-success">
            <i class="bi bi-check-circle me-2"></i>Verificar
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    let currentCustomerId = null;
    let currentCustomerName = null;
    let currentEmail = null;
    let currentAccountNumber = null; // ‚Üê NUEVO

    // ==================== PASO 1: ESCANEAR QR ====================
    document.getElementById("btnScan").addEventListener("click", async () => {
      try {
        console.log('üîç Iniciando escaneo de QR...');
        
        const response = await fetch("http://127.0.0.1:8000/detect");
        
        if (!response.ok) {
          Swal.fire('Error', 'Error al iniciar la detecci√≥n', 'error');
          return;
        }

        let data = await response.json();
        console.log('üì± Datos recibidos:', data);

        if (data === null) {
          Swal.fire('Info', 'No se detect√≥ ning√∫n QR', 'info');
          return;
        }

        if (!data.customerId || !data.customerName) {
          Swal.fire('Error', data.mensaje || 'QR no v√°lido', 'error');
          return;
        }

        // Guardar datos (incluyendo accountNumber del QR)
        currentCustomerId = data.customerId;
        currentCustomerName = data.customerName;
        currentEmail = data.email;
        currentAccountNumber = data.numeroTarjeta || data.accountNumber; // ‚Üê NUEVO
        
        console.log('‚úÖ QR v√°lido - ID:', currentCustomerId);
        console.log('üìù Account Number:', currentAccountNumber);

        // Mostrar bienvenida
        await Swal.fire({
          icon: 'success',
          title: '¬°QR V√°lido!',
          text: 'Bienvenido ' + currentCustomerName,
          timer: 2000,
          showConfirmButton: false
        });

        // Abrir modal de contrase√±a
        showPasswordModal();

      } catch (error) {
        console.error('‚ùå Error:', error);
        Swal.fire('Error', 'Error al comunicarse con el servicio', 'error');
      }
    });

    // ==================== PASO 2: CONTRASE√ëA ====================
    function showPasswordModal() {
      document.getElementById("msgPassword").textContent = 
        `Hola ${currentCustomerName}, ingresa tu contrase√±a`;
      document.getElementById("customerIdInput").value = currentCustomerId;
      document.getElementById("passwordInput").value = "";
      
      const passwordModal = new bootstrap.Modal(document.getElementById('passwordModal'));
      passwordModal.show();
      
      // Focus en el input
      setTimeout(() => {
        document.getElementById('passwordInput').focus();
      }, 500);
    }

    document.getElementById("btnPassword").addEventListener("click", async () => {
      const password = document.getElementById("passwordInput").value;
      const customerId = document.getElementById("customerIdInput").value;
      
      if (!password) {
        Swal.fire('Error', 'Ingresa tu contrase√±a', 'error');
        return;
      }

      try {
        // Mostrar loading
        Swal.fire({
          title: 'Validando...',
          allowOutsideClick: false,
          didOpen: () => {
            Swal.showLoading();
          }
        });

        const res = await fetch(window.location.origin + "/login/password", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ 
            customerId, 
            password,
            accountNumber: currentAccountNumber  // ‚Üê NUEVO: Enviar accountNumber
          })
        });

        const body = await res.json();

        Swal.close();

        if (res.ok && body.success) {
          // Cerrar modal de contrase√±a
          bootstrap.Modal.getInstance(document.getElementById('passwordModal')).hide();
          
          // Mostrar confirmaci√≥n
          await Swal.fire({
            icon: 'success',
            title: '¬°C√≥digo Enviado!',
            text: body.mensaje,
            timer: 2000,
            showConfirmButton: false
          });

          // Abrir modal de c√≥digo
          showCodeModal();
        } else {
          Swal.fire('Error', body.mensaje || 'Contrase√±a incorrecta', 'error');
        }
      } catch (e) {
        console.error("Error:", e);
        Swal.close();
        Swal.fire('Error', 'Error al validar contrase√±a', 'error');
      }
    });

    // Enter en password
    document.getElementById("passwordInput").addEventListener("keypress", (e) => {
      if (e.key === 'Enter') {
        document.getElementById("btnPassword").click();
      }
    });

    // ==================== PASO 3: C√ìDIGO DE VERIFICACI√ìN ====================
    function showCodeModal() {
      console.log('üìß Abriendo modal de c√≥digo');
      console.log('  - currentCustomerId:', currentCustomerId);
      console.log('  - currentEmail:', currentEmail);
      
      if (!currentCustomerId) {
        Swal.fire('Error', 'Error interno: No hay ID de cliente', 'error');
        return;
      }
      
      document.getElementById("msgEmail").textContent = currentEmail;
      document.getElementById("codeInput").value = "";
      
      const codeModal = new bootstrap.Modal(document.getElementById('codeModal'));
      codeModal.show();
      
      // Focus en el input
      setTimeout(() => {
        document.getElementById('codeInput').focus();
      }, 500);
    }

    document.getElementById("btnVerifyCode").addEventListener("click", async () => {
      const code = document.getElementById("codeInput").value;
      
      console.log('üîç Validando c√≥digo...');
      console.log('  - customerId:', currentCustomerId);
      console.log('  - code:', code);
      console.log('  - code length:', code ? code.length : 0);
      
      if (!code || code.length !== 6) {
        Swal.fire('Error', 'Ingresa el c√≥digo de 6 d√≠gitos', 'error');
        return;
      }

      if (!currentCustomerId) {
        Swal.fire('Error', 'Error: No hay ID de cliente', 'error');
        return;
      }

      try {
        const payload = { 
          customerId: currentCustomerId.toString(), 
          code: code.toString().trim()
        };
        
        console.log('üì§ Enviando payload:', payload);

        // Mostrar loading
        Swal.fire({
          title: 'Verificando c√≥digo...',
          allowOutsideClick: false,
          didOpen: () => {
            Swal.showLoading();
          }
        });

        const res = await fetch(window.location.origin + "/login/verify-code", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: 'same-origin',
          body: JSON.stringify(payload)
        });

        const body = await res.json();

        Swal.close();

        if (res.ok && body.success) {
          // Cerrar modal
          bootstrap.Modal.getInstance(document.getElementById('codeModal')).hide();
          
          // Mostrar √©xito
          await Swal.fire({
            icon: 'success',
            title: '¬°Bienvenido!',
            text: 'Acceso concedido',
            timer: 1500,
            showConfirmButton: false
          });
          
          // Redirigir a Mi Cuenta
          window.location.href = body.redirectUrl || "/my-account";
        } else {
          Swal.fire('Error', body.mensaje || 'C√≥digo inv√°lido o expirado', 'error');
        }
      } catch (e) {
        console.error("Error:", e);
        Swal.close();
        Swal.fire('Error', 'Error al verificar c√≥digo', 'error');
      }
    });

    // Enter en c√≥digo
    document.getElementById("codeInput").addEventListener("keypress", (e) => {
      if (e.key === 'Enter') {
        document.getElementById("btnVerifyCode").click();
      }
    });

    // Solo permitir n√∫meros en el c√≥digo
    document.getElementById("codeInput").addEventListener("input", (e) => {
      e.target.value = e.target.value.replace(/[^0-9]/g, '');
    });

    // Limpiar datos SOLO cuando se cierra el modal de c√≥digo
    // (NO limpiar cuando se cierra el de contrase√±a porque a√∫n necesitamos los datos)
    document.getElementById('codeModal').addEventListener('hidden.bs.modal', () => {
      console.log('üßπ Limpiando datos del flujo de login');
      currentCustomerId = null;
      currentCustomerName = null;
      currentEmail = null;
      currentAccountNumber = null; // ‚Üê NUEVO
    });
  </script>
</body>

</html>